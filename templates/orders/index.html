{% extends "base.html" %}
{% block content %}
<div class="container mx-auto mt-10">
  <h1 class="text-3xl font-bold mb-6">Orders</h1>
  <!-- <div class="flex items-center mb-6">
    <input
      type="text"
      id="searchInput"
      placeholder="Search orders..."
      class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
  </div> -->
  <div class="mb-6 border-b border-gray-700 flex space-x-4">
    <button
      id="showBuy"
      class="px-4 py-2 focus:outline-none transition-all
        {% if not show_sell %}bg-gray-800 text-white font-semibold border-b-2 border-blue-500{% else %}text-gray-400 hover:text-white{% endif %}">
      Buy Orders
      <!-- {% if new_buy_orders_count > 0 %}
      <span class="ml-2 inline-block bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full">
        {{ new_buy_orders_count }}
      </span>
      {% endif %} -->
    </button>
    <button
      id="showSell"
      class="px-4 py-2 focus:outline-none transition-all
        {% if show_sell %}bg-gray-800 text-white font-semibold border-b-2 border-blue-500{% else %}text-gray-400 hover:text-white{% endif %}">
      Sell Orders
      <!-- {% if new_sell_orders_count > 0 %}
      <span class="ml-2 inline-block bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full"></span>
        {{ new_sell_orders_count }}
      </span>
      {% endif %} -->
    </button>
  </div>

  <!-- Buy Orders Table -->
  <table
    id="buyOrdersTable"
    class="table-auto w-full mt-6 bg-gray-800 text-white rounded shadow-md"
  >
    <thead class="bg-gray-700">
      <tr>
        <th class="p-4 text-left">Order ID</th>
        <th class="p-4 text-left">User</th>
        <th class="p-4 text-left">Amount</th>
        <th class="p-4 text-left">Price</th>
        <th class="p-4 text-left">Created At</th>
        <th class="p-4 text-left">Status</th>
        <th class="p-4 text-left">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in buy_orders %}
      <tr class="border-b border-gray-700">
        <td class="p-4">{{ order.order_id }}</td>
        <td class="p-4">{{ order.user.name if order.user else 'N/A' }}</td>
        <td class="p-4">{{ order.amount }}</td>
        <td class="p-4">{{ order.price }}</td>
        <td class="p-4">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="p-4">{{ order.status }}</td>
        <td class="p-4 flex space-x-2">
          <a
            href="{{ url_for('orders.view_order', order_id=order.id) }}"
            class="text-blue-400 hover:text-blue-600"
            >View</a
          >
          <form
            action="{{ url_for('orders.delete_order', order_id=order.id) }}"
            method="POST"
            style="display: inline"
          >
            <button
              type="submit"
              class="text-red-400 hover:text-red-600"
              onclick="return confirm('Are you sure you want to delete this order?');"
            >
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="p-4 text-center text-gray-400">No buy orders found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Buy Orders Pagination -->
  <div id="buyOrdersPagination" class="flex justify-center mt-8 {% if show_sell %}hidden{% endif %}">
    <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% if buy_orders_pagination.has_prev %}
        <a href="{{ url_for('orders.index', buy_page=1, sell_page=sell_orders_pagination.page) }}"
           class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">First</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.prev_num, sell_page=sell_orders_pagination.page) }}"
           class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Prev</a>
      {% else %}
        <span class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">First</span>
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Prev</span>
      {% endif %}

      {% for p in range(1, buy_orders_pagination.pages + 1) %}
        {% if p == buy_orders_pagination.page %}
          <span class="px-3 py-2 border-t border-b border-gray-700 bg-blue-600 text-white font-bold">{{ p }}</span>
        {% elif p >= buy_orders_pagination.page - 2 and p <= buy_orders_pagination.page + 2 %}
          <a href="{{ url_for('orders.index', buy_page=p, sell_page=sell_orders_pagination.page) }}"
             class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == 1 or p == buy_orders_pagination.pages %}
          <a href="{{ url_for('orders.index', buy_page=p, sell_page=sell_orders_pagination.page) }}"
             class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == buy_orders_pagination.page - 3 or p == buy_orders_pagination.page + 3 %}
          <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500">...</span>
        {% endif %}
      {% endfor %}

      {% if buy_orders_pagination.has_next %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.next_num, sell_page=sell_orders_pagination.page) }}"
           class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Next</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.pages, sell_page=sell_orders_pagination.page) }}"
           class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Last</a>
      {% else %}
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Next</span>
        <span class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Last</span>
      {% endif %}
    </nav>
  </div>

  <!-- Sell Orders Table -->
  <table
    id="sellOrdersTable"
    class="table-auto w-full mt-6 bg-gray-800 text-white rounded shadow-md hidden"
  >
    <thead class="bg-gray-700">
      <tr>
        <th class="p-4 text-left">User</th>
        <th class="p-4 text-left">Amount</th>
        <th class="p-4 text-left">Price</th>
        <th class="p-4 text-left">Status</th>
        <th class="p-4 text-left">Created At</th>
        <th class="p-4 text-left">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in sell_orders %}
      <tr class="border-b border-gray-700">
        <td class="p-4">{{ order.user.name if order.user else 'N/A' }}</td>
        <td class="p-4">{{ order.amount }}</td>
        <td class="p-4">{{ order.price }}</td>
        <td class="p-4">{{ order.status }}</td>
        <td class="p-4">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="p-4 flex space-x-2">
          <a
            href="{{ url_for('orders.view_order', order_id=order.id) }}"
            class="text-blue-400 hover:text-blue-600"
            >View</a
          >
          <form
            action="{{ url_for('orders.delete_order', order_id=order.id) }}"
            method="POST"
            style="display: inline"
          >
            <button
              type="submit"
              class="text-red-400 hover:text-red-600"
              onclick="return confirm('Are you sure you want to delete this order?');"
            >
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="p-4 text-center text-gray-400">No sell orders found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Sell Orders Pagination -->
  <div id="sellOrdersPagination" class="flex justify-center mt-8 {% if not show_sell %}hidden{% endif %}">
    <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% if sell_orders_pagination.has_prev %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=1) }}"
           class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">First</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.prev_num) }}"
           class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Prev</a>
      {% else %}
        <span class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">First</span>
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Prev</span>
      {% endif %}

      {% for p in range(1, sell_orders_pagination.pages + 1) %}
        {% if p == sell_orders_pagination.page %}
          <span class="px-3 py-2 border-t border-b border-gray-700 bg-blue-600 text-white font-bold">{{ p }}</span>
        {% elif p >= sell_orders_pagination.page - 2 and p <= sell_orders_pagination.page + 2 %}
          <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=p) }}"
             class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == 1 or p == sell_orders_pagination.pages %}
          <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=p) }}"
             class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == sell_orders_pagination.page - 3 or p == sell_orders_pagination.page + 3 %}
          <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500">...</span>
        {% endif %}
      {% endfor %}

      {% if sell_orders_pagination.has_next %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.next_num) }}"
           class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Next</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.pages) }}"
           class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Last</a>
      {% else %}
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Next</span>
        <span class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Last</span>
      {% endif %}
    </nav>
  </div>
</div>

<script>
  const searchInput = document.getElementById("searchInput");
  const buyOrdersTable = document.getElementById("buyOrdersTable");
  const sellOrdersTable = document.getElementById("sellOrdersTable");
  const showBuy = document.getElementById("showBuy");
  const showSell = document.getElementById("showSell");
  const buyOrdersPagination = document.getElementById("buyOrdersPagination");
  const sellOrdersPagination = document.getElementById("sellOrdersPagination");

  function filterTable(table) {
    const filter = searchInput.value.toLowerCase();
    const rows = table.getElementsByTagName("tr");
    for (const row of rows) {
      const cells = row.getElementsByTagName("td");
      if (cells.length === 0) continue;
      const user = cells[0]?.textContent || "";
      const amount = cells[1]?.textContent || "";
      const price = cells[2]?.textContent || "";
      const created = cells[3]?.textContent || "";
      if (
        user.toLowerCase().includes(filter) ||
        amount.toLowerCase().includes(filter) ||
        price.toLowerCase().includes(filter) ||
        created.toLowerCase().includes(filter)
      ) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    }
  }

  // searchInput.addEventListener("input", function () {
  //   if (!buyOrdersTable.classList.contains("hidden")) {
  //     filterTable(buyOrdersTable.tBodies[0]);
  //   } else {
  //     filterTable(sellOrdersTable.tBodies[0]);
  //   }
  // });

  showBuy.addEventListener("click", function () {
    buyOrdersTable.classList.remove("hidden");
    sellOrdersTable.classList.add("hidden");
    buyOrdersPagination.classList.remove("hidden");
    sellOrdersPagination.classList.add("hidden");
    filterTable(buyOrdersTable.tBodies[0]);
  });

  showSell.addEventListener("click", function () {
    sellOrdersTable.classList.remove("hidden");
    buyOrdersTable.classList.add("hidden");
    sellOrdersPagination.classList.remove("hidden");
    buyOrdersPagination.classList.add("hidden");
    filterTable(sellOrdersTable.tBodies[0]);
  });
</script>
{% endblock %}
