{% extends "base.html" %}
{% block content %}
<div class="container mx-auto mt-10">
  <h1 class="text-3xl font-bold mb-6">Orders</h1>
  <div class="mb-6 border-b border-gray-700 flex space-x-4">
    <button id="showBuy"
      class="px-4 py-2 focus:outline-none transition-all border-b-2
        {% if not show_sell %}border-blue-500 text-white font-semibold{% else %}border-transparent text-gray-400 hover:text-white{% endif %}">
      Buy Orders
    </button>
    <button id="showSell"
      class="px-4 py-2 focus:outline-none transition-all border-b-2
        {% if show_sell %}border-blue-500 text-white font-semibold{% else %}border-transparent text-gray-400 hover:text-white{% endif %}">
      Sell Orders
    </button>
  </div>

  <th class="p-4 text-left">
    Status
    <select id="statusFilter" class="ml-2 bg-gray-700 text-white rounded px-2 py-1">
      <option value="">All</option>
      <option value="approved">Approved</option>
      <option value="declined">Declined</option>
      <option value="pending">Pending</option>
      <option value="complain">Complain</option>
    </select>
  </th>

  <script>

    const statusFilter = document.getElementById("statusFilter");

    // Set initial value from query param
    const initialStatus = new URLSearchParams(window.location.search).get('status') || '';
    if (initialStatus) {
      statusFilter.value = initialStatus;
    }

    statusFilter.addEventListener("change", function () {
      const selectedStatus = this.value;
      const url = new URL(window.location.href);
      if (selectedStatus) {
        url.searchParams.set('status', selectedStatus);
      } else {
        url.searchParams.delete('status');
      }
      window.location.href = url.toString();
    });
    // Helper to get query param
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Set active tab based on ?type param
    function setActiveTabFromQuery() {
      const type = getQueryParam('type');
      if (type === 'sell') {

        document.addEventListener('DOMContentLoaded', function () {
          showSell.classList.add('border-blue-500', 'text-white', 'font-semibold');
          showSell.classList.remove('border-transparent', 'text-gray-400');
          showBuy.classList.remove('border-blue-500', 'text-white', 'font-semibold');
          showBuy.classList.add('border-transparent', 'text-gray-400');
          showSell.click();
        });
      } else {
        document.addEventListener('DOMContentLoaded', function () {
          showBuy.classList.add('border-blue-500', 'text-white', 'font-semibold');
          showBuy.classList.remove('border-transparent', 'text-gray-400');
          showSell.classList.remove('border-blue-500', 'text-white', 'font-semibold');
          showSell.classList.add('border-transparent', 'text-gray-400');
          showBuy.click();
        });
      }
    }
    setActiveTabFromQuery();

    // Set URL param when clicking tab
    showBuy.addEventListener('click', function (e) {
      e.preventDefault();
      showBuy.classList.add('border-blue-500', 'text-white', 'font-semibold');
      showBuy.classList.remove('border-transparent', 'text-gray-400');
      showSell.classList.remove('border-blue-500', 'text-white', 'font-semibold');
      showSell.classList.add('border-transparent', 'text-gray-400');
      const url = new URL(window.location.href);
      url.searchParams.set('type', 'buy');
      window.history.replaceState({}, '', url.toString());
    });
    showSell.addEventListener('click', function (e) {
      e.preventDefault();
      showSell.classList.add('border-blue-500', 'text-white', 'font-semibold');
      showSell.classList.remove('border-transparent', 'text-gray-400');
      showBuy.classList.remove('border-blue-500', 'text-white', 'font-semibold');
      showBuy.classList.add('border-transparent', 'text-gray-400');
      const url = new URL(window.location.href);
      url.searchParams.set('type', 'sell');
      window.history.replaceState({}, '', url.toString());
    });

    let lastOrderId = null;

    async function fetchOrdersAndCheck() {
      const type = getQueryParam('type');
      let orderType = type === 'sell' ? 'sell' : 'buy';
      const res = await fetch(`/orders/api/list?page=1&per_page=1`);
      if (!res.ok) return;
      const data = await res.json();
      if (data.orders.length === 0) return;
      const latestOrder = data.orders[0];
      if (lastOrderId === null) {
        lastOrderId = latestOrder.order_id;
        return;
      }
      if (latestOrder.order_id !== lastOrderId) {
        lastOrderId = latestOrder.order_id;
        if (latestOrder.order_id.endsWith('B')) {
          window.location.search = '?type=buy';
        } else {
          window.location.search = '?type=sell';
        }
        window.location.reload();
      }
    }

    setInterval(fetchOrdersAndCheck, 5000);
  </script>

  <!-- Buy Orders Table -->
  <table id="buyOrdersTable" class="table-auto w-full mt-6 bg-gray-800 text-white rounded shadow-md">
    <thead class="bg-gray-700">
      <tr>
        <th class="p-4 text-left">Order ID</th>
        <th class="p-4 text-left">User</th>
        <th class="p-4 text-left">Amount</th>
        <th class="p-4 text-left">Price</th>
        <th class="p-4 text-left">Created At</th>
        <th class="p-4 text-left">Status</th>
        <th class="p-4 text-left">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in buy_orders %}
      <tr class="border-b border-gray-700">
        <td class="p-4">{{ order.order_id }}</td>
        <td class="p-4">{{ order.user.phone if order.user else 'N/A' }}</td>
        <td class="p-4">{{ order.amount }}</td>
        <td class="p-4">{{ order.price }}</td>
        <td class="p-4">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="p-4">{{ order.status }}</td>
        <td class="p-4 flex space-x-2">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}"
            class="text-blue-400 hover:text-blue-600">View</a>
          <form action="{{ url_for('orders.delete_order', order_id=order.id) }}" method="POST" style="display: inline">
            <button type="submit" class="text-red-400 hover:text-red-600"
              onclick="return confirm('Are you sure you want to delete this order?');">
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="p-4 text-center text-gray-400">No buy orders found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Buy Orders Pagination -->
  <div id="buyOrdersPagination" class="flex justify-center mt-8 {% if show_sell %}hidden{% endif %}">
    <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% if buy_orders_pagination.has_prev %}
      <a href="{{ url_for('orders.index', buy_page=1, sell_page=sell_orders_pagination.page) }}"
        class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">First</a>
      <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.prev_num, sell_page=sell_orders_pagination.page) }}"
        class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Prev</a>
      {% else %}
      <span
        class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">First</span>
      <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Prev</span>
      {% endif %}

      {% for p in range(1, buy_orders_pagination.pages + 1) %}
      {% if p == buy_orders_pagination.page %}
      <span class="px-3 py-2 border-t border-b border-gray-700 bg-blue-600 text-white font-bold">{{ p }}</span>
      {% elif p >= buy_orders_pagination.page - 2 and p <= buy_orders_pagination.page + 2 %} <a
        href="{{ url_for('orders.index', buy_page=p, sell_page=sell_orders_pagination.page) }}"
        class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == 1 or p == buy_orders_pagination.pages %}
        <a href="{{ url_for('orders.index', buy_page=p, sell_page=sell_orders_pagination.page) }}"
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == buy_orders_pagination.page - 3 or p == buy_orders_pagination.page + 3 %}
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500">...</span>
        {% endif %}
        {% endfor %}

        {% if buy_orders_pagination.has_next %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.next_num, sell_page=sell_orders_pagination.page) }}"
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Next</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.pages, sell_page=sell_orders_pagination.page) }}"
          class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Last</a>
        {% else %}
        <span
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Next</span>
        <span
          class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Last</span>
        {% endif %}
    </nav>
  </div>

  <!-- Sell Orders Table -->
  <table id="sellOrdersTable" class="table-auto w-full mt-6 bg-gray-800 text-white rounded shadow-md hidden">
    <thead class="bg-gray-700">
      <tr>
        <th class="p-4 text-left">Order ID</th>
        <th class="p-4 text-left">User</th>
        <th class="p-4 text-left">Amount</th>
        <th class="p-4 text-left">Price</th>
        <th class="p-4 text-left">Status</th>
        <th class="p-4 text-left">Created At</th>
        <th class="p-4 text-left">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for order in sell_orders %}
      <tr class="border-b border-gray-700">
        <td class="p-4">{{ order.order_id }}</td>
        <td class="p-4">{{ order.user.phone if order.user else 'N/A' }}</td>
        <td class="p-4">{{ order.amount }}</td>
        <td class="p-4">{{ order.price }}</td>
        <td class="p-4">{{ order.status }}</td>
        <td class="p-4">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        <td class="p-4 flex space-x-2">
          <a href="{{ url_for('orders.view_order', order_id=order.id) }}"
            class="text-blue-400 hover:text-blue-600">View</a>
          <form action="{{ url_for('orders.delete_order', order_id=order.id) }}" method="POST" style="display: inline">
            <button type="submit" class="text-red-400 hover:text-red-600"
              onclick="return confirm('Are you sure you want to delete this order?');">
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="p-4 text-center text-gray-400">No sell orders found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- Sell Orders Pagination -->
  <div id="sellOrdersPagination" class="flex justify-center mt-8 {% if not show_sell %}hidden{% endif %}">
    <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
      {% if sell_orders_pagination.has_prev %}
      <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=1) }}"
        class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">First</a>
      <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.prev_num) }}"
        class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Prev</a>
      {% else %}
      <span
        class="px-3 py-2 rounded-l-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">First</span>
      <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Prev</span>
      {% endif %}

      {% for p in range(1, sell_orders_pagination.pages + 1) %}
      {% if p == sell_orders_pagination.page %}
      <span class="px-3 py-2 border-t border-b border-gray-700 bg-blue-600 text-white font-bold">{{ p }}</span>
      {% elif p >= sell_orders_pagination.page - 2 and p <= sell_orders_pagination.page + 2 %} <a
        href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=p) }}"
        class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == 1 or p == sell_orders_pagination.pages %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=p) }}"
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">{{ p }}</a>
        {% elif p == sell_orders_pagination.page - 3 or p == sell_orders_pagination.page + 3 %}
        <span class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500">...</span>
        {% endif %}
        {% endfor %}

        {% if sell_orders_pagination.has_next %}
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.next_num) }}"
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Next</a>
        <a href="{{ url_for('orders.index', buy_page=buy_orders_pagination.page, sell_page=sell_orders_pagination.pages) }}"
          class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-700 text-white hover:bg-blue-600">Last</a>
        {% else %}
        <span
          class="px-3 py-2 border-t border-b border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Next</span>
        <span
          class="px-3 py-2 rounded-r-md border border-gray-700 bg-gray-900 text-gray-500 cursor-not-allowed">Last</span>
        {% endif %}
    </nav>
  </div>
</div>

<script>
  const searchInput = document.getElementById("searchInput");
  const buyOrdersTable = document.getElementById("buyOrdersTable");
  const sellOrdersTable = document.getElementById("sellOrdersTable");
  const showBuy = document.getElementById("showBuy");
  const showSell = document.getElementById("showSell");
  const buyOrdersPagination = document.getElementById("buyOrdersPagination");
  const sellOrdersPagination = document.getElementById("sellOrdersPagination");

  function filterTable(table) {
    const filter = searchInput.value.toLowerCase();
    const rows = table.getElementsByTagName("tr");
    for (const row of rows) {
      const cells = row.getElementsByTagName("td");
      if (cells.length === 0) continue;
      const user = cells[0]?.textContent || "";
      const amount = cells[1]?.textContent || "";
      const price = cells[2]?.textContent || "";
      const created = cells[3]?.textContent || "";
      if (
        user.toLowerCase().includes(filter) ||
        amount.toLowerCase().includes(filter) ||
        price.toLowerCase().includes(filter) ||
        created.toLowerCase().includes(filter)
      ) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    }
  }

  // searchInput.addEventListener("input", function () {
  //   if (!buyOrdersTable.classList.contains("hidden")) {
  //     filterTable(buyOrdersTable.tBodies[0]);
  //   } else {
  //     filterTable(sellOrdersTable.tBodies[0]);
  //   }
  // });

  showBuy.addEventListener("click", function () {
    buyOrdersTable.classList.remove("hidden");
    sellOrdersTable.classList.add("hidden");
    buyOrdersPagination.classList.remove("hidden");
    sellOrdersPagination.classList.add("hidden");
    filterTable(buyOrdersTable.tBodies[0]);
  });

  showSell.addEventListener("click", function () {
    sellOrdersTable.classList.remove("hidden");
    buyOrdersTable.classList.add("hidden");
    sellOrdersPagination.classList.remove("hidden");
    buyOrdersPagination.classList.add("hidden");
    filterTable(sellOrdersTable.tBodies[0]);
  });
</script>
{% endblock %}