{% extends "base.html" %}
{% block title %}Order Details{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-gray-800 rounded-xl shadow-lg p-8">
    <div class="flex flex-col gap-4 items-center justify-between mb-6">
                    <a href="/messages/{{order.telegram.telegram_id}}"><button class="bg-blue-500 text-xs text-white px-8 py-2 rounded-xl">Go to Chat</button></a>

        <h2 class="text-3xl font-bold flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-blue-400"></i>
            Order #{{ order.order_id }}
        </h2>
        <form method="post" class="flex items-center gap-2">

            <select name="status" class="px-4 py-1 rounded-full text-sm font-semibold
            {% if order.status == 'approved' %}
                bg-green-600 text-white
            {% elif order.status == 'pending' %}
                bg-yellow-500 text-gray-900
            {% elif order.status == 'verified' %}
                bg-blue-500 text-white
            {% elif order.status == 'declined' %}
                bg-red-600 text-white
            {% elif order.status == 'complain' %}
                bg-orange-600 text-white
            {% else %}
                bg-gray-600 text-white
            {% endif %}
            ">
            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="verified" {% if order.status == 'verified' %}selected{% endif %}>Verified</option>
            <option value="approved" {% if order.status == 'approved' %}selected{% endif %}>Approved</option>
            <option value="declined" {% if order.status == 'declined' %}selected{% endif %}>Declined</option>
            <option value="complain" {% if order.status == 'complain' %}selected{% endif %}>Complain</option>
            </select>
            <button type="submit" class="ml-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">
            Update
            </button>
        </form>
        
        <!-- Verified Button - Only show when status is pending -->
        {% if order.status == 'pending' %}
        <form method="post" class="mt-2">
            <button type="submit" name="verify_order" value="1" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold shadow-lg">
                ✓ Verify Order
            </button>
        </form>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2">
        <div class="gap-2">
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Order Info</h3>
            <ul class="space-y-2">
                <li>
                    <span class="font-semibold text-gray-400">Type:</span>
                    <span class="capitalize">{{ order.order_type }}</span>
                </li>
                <form method="post" class=" text-sm bg-blue-100 p-4 rounded-xl text-blue-800 items-center gap-2">
                    <div class="flex">
                    <li>
                        <span class="font-semibold text-gray-400">Amount:</span>
                        <input type="number" step="0.01" name="amount" value="{{ order.amount }}" class="px-2 py-1 rounded bg-gray-700 text-white w-24" id="amount-input">
                    </li>
                    <p id="operation-symbol">
                        {% if order.order_type == 'buy' %}
                            {% if buy_rate < 1 %}÷{% else %}×{% endif %}
                        {% else %}
                            {% if sell_rate < 1 %}×{% else %}÷{% endif %}
                        {% endif %}
                    </p>
                    <li>
                        <span class="font-semibold text-gray-400">Rate:</span>
                        <span id="rate-value">
                            {% if order.order_type == 'buy' %}
                                {{ buy_rate }}
                            {% else %}
                                {{ sell_rate }}
                            {% endif %}
                        </span>
                    </li>
                    <p>=</p>
                    <li>
                        <span class="font-semibold text-gray-400">Total:</span>
                        <span id="total-value" class="font-bold text-blue-400">
                            {% if order.order_type == 'buy' %}
                                {% set rate = buy_rate %}
                                {% if rate < 1 %}
                                    {% set raw_total = order.amount / rate %}
                                {% else %}
                                    {% set raw_total = order.amount * rate %}
                                {% endif %}
                                {{ ((raw_total + 99) // 100 * 100)|int }}
                            {% else %}
                                {% set rate = sell_rate %}
                                {% if rate < 1 %}
                                    {% set raw_total = order.amount * rate %}
                                {% else %}
                                    {% set raw_total = order.amount / rate %}
                                {% endif %}
                                {{ "%.2f"|format(raw_total) }}
                            {% endif %}
                        </span>
                    </li>
                    </div>
                    <button type="submit" class="mt-2 block px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">
                        Update
                    </button>
                </form>
                <script>
                    const amountInput = document.getElementById('amount-input');
                    const rateValue = document.getElementById('rate-value');
                    const totalValue = document.getElementById('total-value');
                    const orderType = '{{ order.order_type }}';
                    
                    amountInput.addEventListener('input', function() {
                        const amount = parseFloat(amountInput.value) || 0;
                        const rate = parseFloat(rateValue.textContent) || 0;
                        let rawTotal;
                        
                        if (orderType === 'buy') {
                            // Buy: THB to MMK
                            rawTotal = rate < 1 ? amount / rate : amount * rate;
                            // Round up to nearest 100
                            const roundedTotal = Math.ceil(rawTotal / 100) * 100;
                            totalValue.textContent = roundedTotal.toFixed(0);
                        } else {
                            // Sell: MMK to THB
                            rawTotal = rate < 1 ? amount * rate : amount / rate;
                            totalValue.textContent = rawTotal.toFixed(2);
                        }
                    });
                </script>
                <li>
                    <span class="font-semibold text-gray-400">Price:</span>
                    <span>{{ order.price }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Created At:</span>
                    <span>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                </li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">User</h3>
            <ul class="space-y-2">
                <li>
                    <span class="font-semibold text-gray-400">Name:</span>
                    <span>{{ order.user.name if order.user else '-' }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Phone:</span>
                    <span>{{ order.user.phone if order.user else '-' }}</span>
                </li>
            </ul>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
        <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Thai Bank Account</h3>
            {% if order.thai_bank_account %}
            <ul class="space-y-2">
                <li>
                    <span class="font-semibold text-gray-400">Bank:</span>
                    <span>{{ order.thai_bank_account.bank_name }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Account Name:</span>
                    <span>{{ order.thai_bank_account.account_name }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Account Number:</span>
                    <span>{{ order.thai_bank_account.account_number }}</span>
                </li>
                {% if order.thai_bank_account.qr_image %}
                <li>
                    <span class="font-semibold text-gray-400">QR:</span>
                    <img src="{{ order.thai_bank_account.qr_image }}" alt="Thai Bank QR" class="w-32 h-32 rounded shadow mt-2">
                </li>
                {% endif %}
            </ul>
            {% else %}
            <p class="text-gray-500">-</p>
            {% endif %}
        </div>
        <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Myanmar Bank Account</h3>
            {% if order.myanmar_bank_account %}
            <ul class="space-y-2">
                <li>
                    <span class="font-semibold text-gray-400">Bank:</span>
                    <span>{{ order.myanmar_bank_account.bank_name }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Account Name:</span>
                    <span>{{ order.myanmar_bank_account.account_name }}</span>
                </li>
                <li>
                    <span class="font-semibold text-gray-400">Account Number:</span>
                    <span>{{ order.myanmar_bank_account.account_number }}</span>
                </li>
                {% if order.myanmar_bank_account.qr_image %}
                <li>
                    <span class="font-semibold text-gray-400">QR:</span>
                    <img src="{{ order.myanmar_bank_account.qr_image }}" alt="Myanmar Bank QR" class="w-32 h-32 rounded shadow mt-2">
                </li>
                {% endif %}
            </ul>
            {% else %}
            <p class="text-gray-500">-</p>
            {% endif %}
        </div>
    </div>

    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Receipt</h3>
            {% if order.receipt %}
                {% for receipt in order.receipt.split(',') %}
                    <img src="{% if receipt.startswith('/') %}{{ receipt }}{% else %}/{{ receipt }}{% endif %}" 
                        class="w-48 h-48 rounded shadow border border-gray-700 mb-4 inline-block mr-2">
                {% endfor %}
            {% else %}
                <p class="text-gray-400">No receipt uploaded</p>
            {% endif %}


            <form method="post" enctype="multipart/form-data" class="flex flex-col gap-2">

                <input type="file" name="receipt" accept="image/*" class="block mt-4 w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" onchange="previewReceipt(event)">
                <img id="receipt-preview" src="#" alt="Preview" class="hidden w-32 h-32 rounded shadow border border-gray-700 mt-2" />
                <script>
                    function previewReceipt(event) {
                        const [file] = event.target.files;
                        const preview = document.getElementById('receipt-preview');
                        if (file) {
                            preview.src = URL.createObjectURL(file);
                            preview.classList.remove('hidden');
                        } else {
                            preview.src = '#';
                            preview.classList.add('hidden');
                        }
                    }
                </script>
                <button type="submit" name="upload_receipt" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">
                    Upload
                </button>
            </form>
        </div>
        <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Confirm Receipt</h3>

            {% if order.confirm_receipt %}
                {% for receipt in order.confirm_receipt.split(',') %}
                    <img src="{% if receipt.startswith('/') %}{{ receipt }}{% else %}/{{ receipt }}{% endif %}" 
                        class="w-48 h-48 rounded shadow border border-gray-700 mb-4 inline-block mr-2">
                {% endfor %}
            {% else %}

                <p class="text-gray-500 mb-4">No confirm receipt uploaded.</p>
            {% endif %}
            <form method="post" enctype="multipart/form-data" class="flex flex-col gap-2">

                <input type="file" name="confirm_receipt" accept="image/*" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" onchange="previewConfirmReceipt(event)">
                <img id="confirm-receipt-preview" src="#" alt="Preview" class="hidden w-32 h-32 rounded shadow border border-gray-700 mt-2" />
                <script>
                    function previewConfirmReceipt(event) {
                        const [file] = event.target.files;
                        const preview = document.getElementById('confirm-receipt-preview');
                        if (file) {
                            preview.src = URL.createObjectURL(file);
                            preview.classList.remove('hidden');
                        } else {
                            preview.src = '#';
                            preview.classList.add('hidden');
                        }
                    }
                </script>
                <button type="submit" name="upload_confirm_receipt" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">
                    Upload
                </button>
            </form>
        </div>
        <!-- <div>
            <h3 class="text-lg font-semibold mb-2 text-gray-300">Order QR</h3>
            {% if order.qr %}
                <img src="{{ order.qr }}" alt="Order QR" class="w-48 h-48 rounded shadow border border-gray-700">
            {% else %}
                <p class="text-gray-500">No QR available.</p>
            {% endif %}
        </div> -->
    </div>
</div>
{% endblock %}