{% extends "base.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Messages</h1>
<div class="mb-4">
    <label for="order-status-filter" class="mr-2 font-medium">Filter by last order status:</label>
    <select id="order-status-filter" class="bg-gray-700 text-white rounded px-2 py-1">
        <option value="all">All</option>
        <option value="pending">Last Order Pending</option>
        <option value="not_pending">Last Order Not Pending</option>
    </select>
</div>
<div class="bg-gray-800 rounded-lg shadow p-6">
    {% if telegrams %}
        <ul id="chat-list">
            {% for t in telegrams %}
                <li class="border-b border-gray-700 py-4 flex items-center justify-between hover:bg-gray-700 transition"
                    data-last-order-pending="{{ 'true' if t.last_order_is_pending else 'false' }}">
                    <div>
                        <a href="{{ url_for('messages_bp.chat_detail', telegram_id=t.telegram_id) }}" class="text-lg font-semibold text-blue-400 hover:underline">
                            {{ t.telegram_id }}
                        </a>
                        <div class="text-gray-400 text-sm mt-1">
                            Last updated: {{ t.updated_at.strftime('%Y-%m-%d %H:%M:%S') if t.updated_at else 'N/A' }}
                        </div>
                        {% if t.user and t.user[-1] %}
                            <div class="text-gray-300 mt-1">
                                <span class="font-medium">Last message:</span>
                                {{ t.user[-1].content|truncate(60) }}
                            </div>
                        {% endif %}
                        {% if t.last_order %}
                            <div class="text-xs mt-1">
                                <span class="font-medium">Last order status:</span>
                                <span class="px-2 py-1 rounded {{ 'bg-yellow-600' if t.last_order.status == 'pending' else 'bg-green-700' }}">
                                    {{ t.last_order.status }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('messages_bp.chat_detail', telegram_id=t.telegram_id) }}" class="text-blue-400 hover:text-blue-200">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-gray-400">No messages found.</div>
    {% endif %}
</div>
<script>
document.getElementById('order-status-filter').addEventListener('change', function() {
    const value = this.value;
    document.querySelectorAll('#chat-list > li').forEach(li => {
        const pending = li.getAttribute('data-last-order-pending') === 'true';
        if (value === 'all') {
            li.style.display = '';
        } else if (value === 'pending' && pending) {
            li.style.display = '';
        } else if (value === 'not_pending' && !pending) {
            li.style.display = '';
        } else {
            li.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
