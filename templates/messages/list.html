{% extends "base.html" %}
{% block title %}Messages{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Messages</h1>
<div class="mb-4">
    <label for="order-status-filter" class="mr-2 font-medium">Filter by last order status:</label>
    <select id="order-status-filter" class="bg-gray-700 text-white rounded px-2 py-1">
        <option value="all">All</option>
        <option value="pending">Pending Orders</option>
        <option value="not_pending">In Conversation</option>
    </select>
</div>
<div class="bg-gray-800 rounded-lg shadow p-6">
    {% if telegrams %}
        <ul id="chat-list">
            {% for t in telegrams %}
                <li class="border-b border-gray-700 py-4 flex items-center justify-between hover:bg-gray-700 transition"
                    data-last-order-pending="{{ 'true' if t.last_order_is_pending else 'false' }}">
                    <div>
                        <a href="{{ url_for('messages_bp.chat_detail', telegram_id=t.telegram_id) }}" class="text-lg font-semibold text-blue-400 hover:underline">
                            {{ t.telegram_id }}
                        </a>
                        <div class="text-gray-400 text-sm mt-1">
                            Last updated: {{ t.updated_at.strftime('%Y-%m-%d %H:%M:%S') if t.updated_at else 'N/A' }}
                        </div>
                        {% if t.user and t.user[-1] %}
                            <div class="text-gray-300 mt-1">
                                <span class="font-medium">Last message:</span>
                                {{ t.user[-1].content|truncate(60) }}
                            </div>
                        {% endif %}
                        {% if t.last_order %}
                            <div class="text-xs mt-1">
                                <span class="font-medium">Last order status:</span>
                                <span class="px-2 py-1 rounded 
                                    {% if t.last_order.status == 'pending' %}
                                        bg-yellow-600
                                    {% elif t.last_order.status == 'complain' %}
                                        bg-red-600
                                    {% else %}
                                        bg-green-700
                                    {% endif %}
                                ">
                                    {{ t.last_order.status }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('messages_bp.chat_detail', telegram_id=t.telegram_id) }}" class="text-blue-400 hover:text-blue-200">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-gray-400">No messages found.</div>
    {% endif %}
</div>
<script>
document.getElementById('order-status-filter').addEventListener('change', function() {
    const value = this.value;
    document.querySelectorAll('#chat-list > li').forEach(li => {
        const pending = li.getAttribute('data-last-order-pending') === 'true';
        if (value === 'all') {
            li.style.display = '';
        } else if (value === 'pending' && pending) {
            li.style.display = '';
        } else if (value === 'not_pending' && !pending) {
            li.style.display = '';
        } else {
            li.style.display = 'none';
        }
    });
});
</script>
<script>
function refreshChatList() {
    fetch("{{ url_for('messages_bp.api_chat_list') }}")
        .then(response => response.json())
        .then(data => {
            const chatList = document.getElementById('chat-list');
            if (!chatList) return;
            chatList.innerHTML = '';
            data.forEach(t => {
                // Determine last order status and pending flag (if available)
                // You may need to adjust this if your API returns more fields
                let lastOrderStatus = t.last_order_status || '';
                let lastOrderIsPending = lastOrderStatus === 'pending';
                let lastMessage = t.last_message || '';
                let updatedAt = t.updated_at || 'N/A';

                const li = document.createElement('li');
                li.className = "border-b border-gray-700 py-4 flex items-center justify-between hover:bg-gray-700 transition";
                li.setAttribute('data-last-order-pending', lastOrderIsPending ? 'true' : 'false');

                li.innerHTML = `
                    <div>
                        <a href="/messages/${t.telegram_id}" class="text-lg font-semibold text-blue-400 hover:underline">
                            ${t.telegram_id}
                        </a>
                        <div class="text-gray-400 text-sm mt-1">
                            Last updated: ${updatedAt}
                        </div>
                        ${lastMessage ? `
                            <div class="text-gray-300 mt-1">
                                <span class="font-medium">Last message:</span>
                                ${lastMessage.length > 60 ? lastMessage.substring(0, 60) + '...' : lastMessage}
                            </div>
                        ` : ''}
                        ${lastOrderStatus ? `
                            <div class="text-xs mt-1">
                                <span class="font-medium">Last order status:</span>
                                <span class="px-2 py-1 rounded ${lastOrderStatus === 'pending' ? 'bg-yellow-600' : 'bg-green-700'}">
                                    ${lastOrderStatus}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    <a href="/messages/${t.telegram_id}" class="text-blue-400 hover:text-blue-200">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                `;
                chatList.appendChild(li);
            });

            // Re-apply filter after refresh
            const filter = document.getElementById('order-status-filter');
            if (filter) {
                const event = new Event('change');
                filter.dispatchEvent(event);
            }
        });
}

// Initial load and set interval
setInterval(refreshChatList, 5000);
</script>
{% endblock %}
