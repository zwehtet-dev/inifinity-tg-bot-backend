{% extends "base.html" %}
{% block title %}Chat with {{ telegram.telegram_id }}{% endblock %}

{% block content %}
<style>
</style>
<div class="max-w-2xl mx-auto bg-gray-800 rounded-lg shadow-lg -mx-8" id="chat-header">
    <div class="flex flex-col md:flex-row items-center mb-6 p-4">
        <i class="fas fa-user-circle text-3xl mr-3"></i>
        <h2 class="text-sm md:text-xl font-semibold">Chat with <span class="text-blue-400">{{ telegram.telegram_id
                }}</span></h2>
        <a href="/messages" class="ml-auto text-gray-400 hover:text-white text-sm"><i
                class="fas fa-arrow-left mr-1"></i>Back to chats</a>
    </div>

    <script>
        function fetchAndUpdateOrderStatus() {
            fetch('/messages/api/{{ telegram.telegram_id }}/messages')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('status');
                    if (data.latest_order) {
                        // If the order status box exists, update its content
                        if (container) {
                            container.querySelector('#latest-order-id').textContent = data.latest_order.order_id || 'N/A';
                            document.getElementById('order-status').textContent = data.latest_order.status.charAt(0).toUpperCase() + data.latest_order.status.slice(1);
                            // Also update the select value if form is open
                            const select = document.getElementById('order-status-select');
                            // if (select) select.value = data.latest_order.status;
                        } else {
                            // If it doesn't exist, insert the whole HTML
                            const parent = document.querySelector('#chat-header');
                            if (parent) {
                                parent.insertAdjacentHTML('afterbegin', `
        <div id="status" class="mb-4 z-[999] fixed top-0 left-0 right-0 w-full p-4 bg-gray-700 rounded border border-gray-600 text-xs md:text-sm">
            <div class="flex items-center justify-between">
                <div>
                    <span class="font-semibold text-gray-200">Latest Order ID:</span>
                    <a href="/orders/${data.latest_order.id}" class="text-blue-300 underline" id="latest-order-id">${data.latest_order.order_id || 'N/A'}</a>
                    <span class=" font-semibold text-gray-200">Status:</span>
                    <span id="order-status" class="text-yellow-300">${data.latest_order.status.charAt(0).toUpperCase() + data.latest_order.status.slice(1)}</span>
                </div>
                <button id="edit-status-btn"
                    class="ml-4 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">Edit</button>
            </div>
            <form id="order-status-form" class="mt-2 hidden flex items-center gap-2">
                <select id="order-status-select"
                    class="bg-gray-800 text-white border border-gray-600 rounded px-2 py-1 text-sm">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="declined">Declined</option>
                    <option value="complain">Complain</option>
                </select>
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">Save</button>
                <button type="button" id="cancel-edit-btn"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">Cancel</button>
            </form>
            <div id="order-status-msg" class="mt-2 text-xs"></div>

        </div>`);
                            }

                        }
                    } else if (container) {
                        // If there is no latest order, remove the box if it exists
                        container.remove();
                    }

                    if (window.history && window.history.replaceState) {
                        const url = new URL(window.location);
                        url.searchParams.set("order_id", data.latest_order.id || "");
                        window.history.replaceState({}, "", url);
                    }
                });


            const editBtn = document.getElementById('edit-status-btn');
            const form = document.getElementById('order-status-form');
            const statusSpan = document.getElementById('order-status');
            const select = document.getElementById('order-status-select');
            const msgDiv = document.getElementById('order-status-msg');
            const cancelBtn = document.getElementById('cancel-edit-btn');

            editBtn.addEventListener('click', function () {
                form.classList.remove('hidden');
                editBtn.classList.add('hidden');
                msgDiv.textContent = '';
            });

            cancelBtn.addEventListener('click', function () {
                form.classList.add('hidden');
                editBtn.classList.remove('hidden');
                msgDiv.textContent = '';
                // select.value = statusSpan.textContent.trim().toLowerCase();
            });

            form.addEventListener('submit', function (e) {
                e.preventDefault();
                fetch('/messages/{{ telegram.telegram_id }}/order_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: select.value })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // statusSpan.textContent = select.value.charAt(0).toUpperCase() + select.value.slice(1);
                            msgDiv.textContent = 'Order status updated!';
                            msgDiv.className = 'mt-2 text-xs text-green-400';
                            form.classList.add('hidden');
                            editBtn.classList.remove('hidden');
                        } else {
                            msgDiv.textContent = data.error || 'Failed to update status.';
                            msgDiv.className = 'mt-2 text-xs text-red-400';
                        }
                    })
                    .catch(() => {
                        msgDiv.textContent = 'Failed to update status.';
                        msgDiv.className = 'mt-2 text-xs text-red-400';
                    });
            });
        }
        setInterval(fetchAndUpdateOrderStatus, 1000);


        function updateOrderAmount() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            const forms = document.getElementsByClassName('update-amount-form');
            const form = forms.length ? forms[forms.length - 1] : null;
            const amount = form.querySelector('input[name="amount"]').value;
            const formData = new FormData(form);
            fetch(`/orders/${orderId}`, {
                method: 'POST',
                body: formData
            })
                .then(res => {
                    if (res.ok) {
                        if (!form.querySelector('.amount-update-msg')) {
                            form.insertAdjacentHTML('beforeend', '<span class="ml-2 text-green-400 text-xs amount-update-msg">Amount updated!</span>');
                        }
                    } else {
                        if (!form.querySelector('.amount-update-msg')) {

                            form.insertAdjacentHTML('beforeend', '<span class="ml-2 text-red-400 text-xs">Failed to update.</span>');
                        }
                    }
                    setTimeout(() => {
                        const msg = form.querySelector('span');
                        if (msg) msg.remove();
                    }, 2000);
                })
                .catch(() => {
                    form.insertAdjacentHTML('beforeend', '<span class="ml-2 text-red-400 text-xs">Error updating.</span>');
                    setTimeout(() => {
                        const msg = form.querySelector('span');
                        if (msg) msg.remove();
                    }, 2000);
                });
        }
    </script>


    <div id="chat-messages" class="space-y-4 h-96 overflow-y-auto bg-gray-900 rounded p-4 border border-gray-700">

        <div class="text-center text-gray-400">Loading...</div>

    </div>
    <form id="send-message-form" class="mt-4 flex flex-col md:flex-row gap-2">
        <div class="relative flex-grow">
            <div id="typing-suggestion"
                class="absolute left-0 bottom-full mt-1 bg-blue-100 text-gray-800 px-3 py-1 rounded shadow hidden text-sm cursor-pointer z-10"
                onclick="applySuggestion()">
                confirmed
            </div>
            <input id="message-input" name="content" type="text" autocomplete="off" placeholder="Type a message..."
                class="w-full px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none"
                required oninput="showSuggestion(this)">
        </div>
        <script>
            function showSuggestion(input) {
                const suggestion = document.getElementById('typing-suggestion');
                const value = input.value.trim().toLowerCase();
                // Show suggestion if input matches start of "confirmed"
                if ("confirmed".startsWith(value) && value.length > 0 && value !== "confirmed") {
                    suggestion.classList.remove('hidden');
                } else {
                    suggestion.classList.add('hidden');
                }
            }
            function applySuggestion() {
                const input = document.getElementById('message-input');
                input.value = "confirmed";
                document.getElementById('typing-suggestion').classList.add('hidden');
                input.focus();
            }
        </script>
        <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">Send</button>
        <input id="image-input" name="image" type="file" accept="image/*" class="hidden" multiple>
        <label for="image-input"
            class="cursor-pointer bg-gray-600 hover:bg-gray-500 text-white p-1 rounded flex items-center justify-center">
            <i class="fas fa-paperclip mr-1 text-xs"></i> Attach
        </label>
    </form>
    <div id="attachment-preview" class="mt-2"></div>


    <div id="image-modal"
        class="fixed inset-0 z-[99999] flex items-center justify-center bg-black bg-opacity-80 hidden">
        <span class="absolute top-4 right-6 text-white text-3xl cursor-pointer"
            onclick="closeImageModal()">&times;</span>
        <a id="download-image-link" href="#" download
            class="absolute top-4 left-6 bg-gray-800 text-white px-3 py-1 rounded hover:bg-gray-700 text-sm flex items-center gap-2">
            <i class="fas fa-download"></i> Download
        </a>
        <img id="modal-image" src="" alt="Zoomed Image"
            class="max-h-[90vh] max-w-[90vw] rounded shadow-lg border-4 border-gray-700">
    </div>
    <script>
        function showImageModal(src) {
            var modal = document.getElementById('image-modal');
            var modalImg = document.getElementById('modal-image');
            var downloadLink = document.getElementById('download-image-link');
            modal.classList.remove('hidden');
            modalImg.src = src;
            downloadLink.href = src;
        }
        function closeImageModal() {
            var modal = document.getElementById('image-modal');
            var modalImg = document.getElementById('modal-image');
            modal.classList.add('hidden');
            modalImg.src = '';
        }
        // Close modal on ESC or click outside image
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeImageModal();
        });
        document.getElementById('image-modal').addEventListener('click', function (e) {
            if (e.target === this) closeImageModal();
        });
    </script>

    <script>
        const imageInput = document.getElementById('image-input');
        const previewDiv = document.getElementById('attachment-preview');

        imageInput.addEventListener('change', function () {
            previewDiv.innerHTML = '';
            if (this.files && this.files.length > 0) {
                Array.from(this.files).forEach((file, idx) => {
                    const container = document.createElement('div');
                    container.className = 'inline-block mr-2 mb-2 relative';

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'absolute top-1 right-1 text-red-400 hover:text-red-600 text-xs underline bg-gray-800 rounded px-1';
                    removeBtn.textContent = '✕';
                    removeBtn.onclick = function () {
                        // Remove this file from the input
                        const dt = new DataTransfer();
                        Array.from(imageInput.files).forEach((f, i) => {
                            if (i !== idx) dt.items.add(f);
                        });
                        imageInput.files = dt.files;
                        previewDiv.innerHTML = '';
                        imageInput.dispatchEvent(new Event('change'));
                    };

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.className = 'max-h-24 rounded border border-gray-600';
                        img.style.maxWidth = '120px';
                        img.alt = file.name;
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        container.appendChild(img);
                    } else {
                        const fileInfo = document.createElement('span');
                        fileInfo.className = 'text-gray-300';
                        fileInfo.textContent = file.name;
                        container.appendChild(fileInfo);
                    }
                    container.appendChild(removeBtn);
                    previewDiv.appendChild(container);
                });
            }
        });
    </script>
</div>
<script>
    document.getElementById('send-message-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const content = input.value.trim();

        const order_status = document.getElementById('order-status').textContent

        if (order_status=='pending' && content=='confirmed'){
            alert("You can't send confirmed message before updating the order status from pending");
            return
        }
        
        if (!content) return;
        const formData = new FormData();
        formData.append('telegram_id', '{{ telegram.telegram_id }}');
        formData.append('chat_id', '{{ telegram.chat_id }}');
        formData.append('content', content);
        formData.append('from_bot', 'true');
        formData.append('from_backend', 'true');
        const imageInput = document.getElementById('image-input');
        if (imageInput.files.length > 0) {
            for (let i = 0; i < imageInput.files.length; i++) {
                formData.append('image', imageInput.files[i]);
            }
        }
        fetch('/api/message/submit', {
            method: 'POST',
            body: formData
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to send');
                input.value = '';
                fetchAndUpdateMessages();
                // Scroll to bottom after sending
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 200); // slight delay to ensure messages are rendered
                }
                imageInput.value = '';
                previewDiv.innerHTML = '';
            })
            .catch(() => console.log('Failed to send message'));
    });
    document.getElementById('message-input').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('send-message-form').dispatchEvent(new Event('submit'));
        }
    });

    function updateOrderTypeLabels() {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id') || '';
        const labels = document.querySelectorAll('.order-type-label');
        
        // for all labels

        labels.forEach(label => {
            if (orderId.endsWith('S')) {
                label.textContent = 'Sell';
            } else if (orderId.endsWith('B')) {
                label.textContent = 'Buy';
            } else {
                label.textContent = '';
            }
        });

        console.log('Updated order type labels to:', orderId);
    }
    // Initial call and update every 1s for realtime
    updateOrderTypeLabels();
    setInterval(updateOrderTypeLabels, 1000);
</script>
<script>
    window.addEventListener('DOMContentLoaded', function () {
        var chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
    function renderMessages(messages) {
        return messages.map(function (message) {
            let buttonsHtml = '';
            if (message.buttons) {
                try {
                    const buttons = JSON.parse(message.buttons);
                    buttonsHtml = `<div class="mt-2 flex flex-wrap gap-2">` +
                        Object.entries(buttons).map(([key, value]) =>
                            `<button class="bg-gray-600 hover:bg-gray-500 text-xs px-2 py-1 rounded">${value}</button>`
                        ).join('') +
                        `</div>`;
                } catch (e) { }
            }
            return `
        <div class="flex h-fit ${message.from_bot ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs px-4 py-2 rounded-lg
                ${message.from_bot ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-100'}">

                <button type="button" class="rounded-xl p-2 bg-blue-400 text-white hover:text-gray-100 text-[10px] mb-2" title="Copy" onclick="navigator.clipboard.writeText(document.getElementById('msg-content-${message.id}').textContent);alert('Copied!')">
                    <i class="fas fa-copy"></i> copy
                </button>
                <div class="break-words text-xs md:text-sm" id="msg-content-${message.id}">${message.content || ''}</div>
                ${(message.content && message.content.includes('ခဏစောင့်ပါနော်'))
                    ? (() => {
                        return `
                            <form class="flex update-amount-form items-center gap-2 mt-2" onsubmit="event.preventDefault(); updateOrderAmount()">
                                <span class="font-semibold order-type-label"></span>
                                <input type="number" step="0.01" name="amount" class="px-2 py-1 bg-gray-100 text-black rounded bg-gray-700 text-white w-24" required>
                                <button type="submit" class="ml-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold">
                                    Update Amount
                                </button>
                            </form>
                        `;
                    })()
                    : ''
                }
                ${message.chosen_option ? `<div class="text-xs text-gray-300 mt-1">Option: ${message.chosen_option}</div>` : ''}

                ${message.image
                    ? (() => {
                        const images = message.image.split(',').map(imgUrl => imgUrl.trim()).filter(Boolean);
                        if (images.length === 1) {
                            return `
                                    <img src="/${images[0]}" alt="Image"
                                        class="mt-2 rounded h-40 border border-gray-600 cursor-zoom-in"
                                        onclick="showImageModal('/${images[0]}')">
                                `;
                        } else if (images.length > 1) {
                            return `
                                    <div class="mt-2 flex flex-wrap gap-2">
                                        ${images.map(imgUrl => `
                                            <img src="/${imgUrl}" alt="Image"
                                                class="rounded h-24 w-24 object-cover border border-gray-600 cursor-zoom-in"
                                                onclick="showImageModal('/${imgUrl}')">
                                        `).join('')}
                                    </div>
                                `;
                        }
                        return '';
                    })()
                    : ''
                }
                <!-- Image Modal (only one in DOM, so don't duplicate here) -->
                
                ${buttonsHtml}
            </div>
        </div>
        `;
        }).join('') || `<div class="text-center text-gray-400">No messages yet.</div>`;
    }

    function fetchAndUpdateMessages() {
        fetch(`/messages/api/chat/{{ telegram.telegram_id }}`)
            .then(response => response.json())
            .then(data => {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages && data && data.messages) {

                    const no_initial_message = chatMessages.innerHTML.trim() === '<div class="text-center text-gray-400">Loading...</div>';
                    if (!window._prevMessages || window._prevMessages.length === 0) {
                        // First load, render all messages
                        chatMessages.innerHTML = renderMessages(data.messages);
                    } else if (data.messages.length === window._prevMessages.length) {
                        // Check if messages have shifted (e.g., new message replaces oldest)
                        let shifted = false;
                        for (let i = 0; i < data.messages.length; i++) {
                            if (JSON.stringify(data.messages[i]) !== JSON.stringify(window._prevMessages[i])) {
                                shifted = true;
                                break;
                            }
                        }
                        if (shifted) {
                            // Only append new/changed messages by id
                            const prevIds = new Set(window._prevMessages.map(m => m.id));
                            const newMessages = data.messages.filter(m => !prevIds.has(m.id));
                            if (newMessages.length > 0) {
                                chatMessages.innerHTML += renderMessages(newMessages);
                            }
                        }

                    } else if (data.messages.length > window._prevMessages.length) {
                        // Only render the newly arrived message(s)
                        const newMessages = data.messages.slice(window._prevMessages.length);
                        chatMessages.innerHTML += renderMessages(newMessages);
                    }

                    console.log(no_initial_message)

                    // Scroll if any message has seen_by_admin === false
                    const shouldScroll = data.messages.some(msg => msg.seen_by_admin === false);

                    if (
                        !window._prevMessages ||
                        data.messages === window._prevMessages ||
                        no_initial_message ||
                        shouldScroll
                    ) {
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;

                        }, 200);
                    }
                    window._prevMessages = data.messages;
                }
            });
    }

    setInterval(fetchAndUpdateMessages, 1000);
</script>
{% endblock %}